/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.PaperScroller=joint.mvc.View.extend({className:"paper-scroller",options:{paper:void 0,padding:function(){var a=Math.max(this.options.minVisiblePaperSize,1)||1,b={};return b.left=b.right=Math.max(this.el.clientWidth-a,0),b.top=b.bottom=Math.max(this.el.clientHeight-a,0),b},minVisiblePaperSize:50,autoResizePaper:!1,baseWidth:void 0,baseHeight:void 0,contentOptions:void 0,cursor:"default"},_padding:{left:0,top:0},init:function(){_.bindAll(this,"startPanning","stopPanning","pan","onBackgroundEvent");var a=this.options.paper,b=a.scale();this._sx=b.sx,this._sy=b.sy,_.isUndefined(this.options.baseWidth)&&(this.options.baseWidth=a.options.width),_.isUndefined(this.options.baseHeight)&&(this.options.baseHeight=a.options.height),this.$background=$("<div/>").addClass("paper-scroller-background").css({width:a.options.width,height:a.options.height}).append(a.el).appendTo(this.el),this.listenTo(a,"scale",this.onScale).listenTo(a,"resize",this.onResize).listenTo(a,"beforeprint beforeexport",this.storeScrollPosition).listenTo(a,"afterprint afterexport",this.restoreScrollPosition),this.options.autoResizePaper&&(this.listenTo(a.model,"change add remove reset",this.adjustPaper),a.options.async&&this.listenTo(a,"render:done",this.adjustPaper)),this.delegateBackgroundEvents(),this.setCursor(this.options.cursor)},lock:function(){return this.$el.css("overflow","hidden"),this},unlock:function(){return this.$el.css("overflow","scroll"),this},setCursor:function(a){switch(a){case"grab":this.$el.css("cursor","");break;default:this.$el.css("cursor",a)}return this.$el.attr("data-cursor",a),this.options.cursor=a,this},delegateBackgroundEvents:function(a){function b(a,b,c){return c.indexOf(" ")===-1&&(a[c]=_.isFunction(b)?b:this.options.paper[b]),a}function c(a,b){this.delegate(b,{guarded:!1},this.onBackgroundEvent)}a||(a=_.result(this.options.paper,"events"));var d=this.paperEvents=_.reduce(a,_.bind(b,this),{});return _.each(d,_.bind(c,this)),this},onBackgroundEvent:function(a){if(this.$background.is(a.target)){var b=this.paperEvents[a.type];_.isFunction(b)&&b.apply(this.options.paper,arguments)}},onResize:function(){this._center&&this.center(this._center.x,this._center.y)},onScale:function(a,b,c,d){this.adjustScale(a,b),this._sx=a,this._sy=b,(c||d)&&this.center(c,d)},storeScrollPosition:function(){this._scrollLeftBeforePrint=this.el.scrollLeft,this._scrollTopBeforePrint=this.el.scrollTop},restoreScrollPosition:function(){this.el.scrollLeft=this._scrollLeftBeforePrint,this.el.scrollTop=this._scrollTopBeforePrint,this._scrollLeftBeforePrint=null,this._scrollTopBeforePrint=null},beforePaperManipulation:function(){this.$el.css("visibility","hidden")},afterPaperManipulation:function(){this.$el.css("visibility","visible")},clientToLocalPoint:function(a,b){var c=this.options.paper.matrix();return a+=this.el.scrollLeft-this._padding.left-c.e,a/=c.a,b+=this.el.scrollTop-this._padding.top-c.f,b/=c.d,g.point(a,b)},localToBackgroundPoint:function(a,b){var c=g.Point(a,b),d=this.options.paper.matrix(),e=this._padding;return V.transformPoint(c,d).offset(e.left,e.top)},adjustPaper:function(){this._center=this.clientToLocalPoint(this.el.clientWidth/2,this.el.clientHeight/2);var a=_.extend({gridWidth:this.options.baseWidth,gridHeight:this.options.baseHeight,allowNewOrigin:"negative"},this.options.contentOptions);return this.options.paper.fitToContent(this.transformContentOptions(a)),this},adjustScale:function(a,b){var c=this.options.paper.options,d=a/this._sx,e=b/this._sy;this.options.paper.setOrigin(c.origin.x*d,c.origin.y*e),this.options.paper.setDimensions(c.width*d,c.height*e)},transformContentOptions:function(a){var b=this._sx,c=this._sy;return a.gridWidth&&(a.gridWidth*=b),a.gridHeight&&(a.gridHeight*=c),a.minWidth&&(a.minWidth*=b),a.minHeight&&(a.minHeight*=c),_.isObject(a.padding)?a.padding={left:(a.padding.left||0)*b,right:(a.padding.right||0)*b,top:(a.padding.top||0)*c,bottom:(a.padding.bottom||0)*c}:_.isNumber(a.padding)&&(a.padding=a.padding*b),a},center:function(a,b,c){var d=this.options.paper.matrix(),e=-d.e,f=-d.f,g=e+this.options.paper.options.width,h=f+this.options.paper.options.height;_.isUndefined(a)||_.isUndefined(b)?(a=(e+g)/2,b=(f+h)/2):(a*=d.a,b*=d.d);var i=this.getPadding(),j=this.el.clientWidth/2,k=this.el.clientHeight/2,l=j-i.left-a+e,m=j-i.right+a-g,n=k-i.top-b+f,o=k-i.bottom+b-h;return this.addPadding(Math.max(l,0),Math.max(m,0),Math.max(n,0),Math.max(o,0)),this.scroll(a,b,_.isUndefined(c)?a||null:c),this},centerContent:function(a){var b=V(this.options.paper.viewport).bbox(!0,this.options.paper.svg);return this.center(b.x+b.width/2,b.y+b.height/2,a),this},centerElement:function(a){this.checkElement(a,"centerElement");var b=a.getBBox().center();return this.center(b.x,b.y)},scroll:function(a,b,c){var d=this.options.paper.matrix(),e={};if(_.isNumber(a)){var f=this.el.clientWidth/2;e.scrollLeft=a-f+d.e+(this._padding.left||0)}if(_.isNumber(b)){var g=this.el.clientHeight/2;e.scrollTop=b-g+d.f+(this._padding.top||0)}c&&c.animation?this.$el.animate(e,c.animation):this.$el.prop(e)},scrollToElement:function(a,b){this.checkElement(a,"scrollToElement");var c=a.getBBox().center(),d=this._sx,e=this._sy;return c.x*=d,c.y*=e,this.scroll(c.x,c.y,b)},addPadding:function(a,b,c,d){var e=this.getPadding(),f=this._padding={left:Math.round(e.left+(a||0)),top:Math.round(e.top+(c||0)),bottom:Math.round(e.bottom+(d||0)),right:Math.round(e.right+(b||0))};return this.$background.css({width:f.left+this.options.paper.options.width+f.right,height:f.top+this.options.paper.options.height+f.bottom}),this.options.paper.$el.css({left:f.left,top:f.top}),this},zoom:function(a,b){if(void 0===a)return this._sx;b=b||{};var c,d,e=this.clientToLocalPoint(this.el.clientWidth/2,this.el.clientHeight/2),f=a,g=a;if(b.absolute||(f+=this._sx,g+=this._sy),b.grid&&(f=Math.round(f/b.grid)*b.grid,g=Math.round(g/b.grid)*b.grid),b.max&&(f=Math.min(b.max,f),g=Math.min(b.max,g)),b.min&&(f=Math.max(b.min,f),g=Math.max(b.min,g)),_.isUndefined(b.ox)||_.isUndefined(b.oy))c=e.x,d=e.y;else{var h=f/this._sx,i=g/this._sy;c=b.ox-(b.ox-e.x)/h,d=b.oy-(b.oy-e.y)/i}return this.beforePaperManipulation(),this.options.paper.scale(f,g),this.center(c,d),this.afterPaperManipulation(),this},zoomToFit:function(a){a=a||{};var b=this.options.paper,c=_.clone(b.options.origin);return a.fittingBBox=a.fittingBBox||_.extend({},g.point(c),{width:this.$el.width(),height:this.$el.height()}),this.beforePaperManipulation(),b.scaleContentToFit(a),b.setOrigin(c.x,c.y),this.adjustPaper().centerContent(),this.afterPaperManipulation(),this},transitionClassName:"transition-in-progress",transitionEventName:"transitionend.paper-scroller-transition",transitionToPoint:function(a,b,c){_.isObject(a)&&(c=b,b=a.y,a=a.x),c||(c={});var d,e,f=this._sx,h=Math.max(c.scale||f,1e-6),i=g.Point(a,b),j=this.clientToLocalPoint(this.el.clientWidth/2,this.el.clientHeight/2);if(f===h){var k=j.difference(i).scale(f,f).round();d="translate("+k.x+"px,"+k.y+"px)"}else{var l=h/(f-h)*i.distance(j),m=j.clone().move(i,l),n=this.localToBackgroundPoint(m).round();d="scale("+h/f+")",e=n.x+"px "+n.y+"px"}return this.$el.addClass(this.transitionClassName),this.$background.off(this.transitionEventName).on(this.transitionEventName,_.bind(function(a){var b=this.paperScroller.removeTransition().zoom(this.scale,{absolute:!0}).center(this.x,this.y),c=this.onTransitionEnd;_.isFunction(c)&&c.call(b,a)},{paperScroller:this,scale:h,x:a,y:b,onTransitionEnd:c.onTransitionEnd})).css({transition:"transform",transitionDuration:c.duration||"1s",transitionDelay:c.delay,transitionTimingFunction:c.timingFunction,transformOrigin:e,transform:d}),this},removeTransition:function(){return this.$el.removeClass(this.transitionClassName),this.$background.off(this.transitionEventName).css({transition:"",transitionDuration:"",transitionDelay:"",transitionTimingFunction:"",transform:"",transformOrigin:""}),this},transitionToRect:function(a,b){a=g.Rect(a),b||(b={});var c=b.maxScale||1/0,d=b.minScale||Number.MIN_VALUE,e=b.scaleGrid||null,f=b.visibility||1,h=b.center?g.Point(b.center):a.center(),i=this.el.clientWidth*f,j=this.el.clientHeight*f,k=g.Rect({x:h.x-i/2,y:h.y-j/2,width:i,height:j}),l=k.maxRectUniformScaleToFit(a,h);return l=Math.min(l,c),e&&(l=Math.floor(l/e)*e),l=Math.max(d,l),this.transitionToPoint(h,_.defaults({scale:l},b))},startPanning:function(a){a=joint.util.normalizeEvent(a),this._clientX=a.clientX,this._clientY=a.clientY,this.$el.addClass("is-panning"),this.trigger("pan:start",a),$(document.body).on({"mousemove.panning touchmove.panning":this.pan,"mouseup.panning touchend.panning":this.stopPanning}),$(window).on("mouseup.panning",this.stopPanning)},pan:function(a){a=joint.util.normalizeEvent(a);var b=a.clientX-this._clientX,c=a.clientY-this._clientY;this.el.scrollTop-=c,this.el.scrollLeft-=b,this._clientX=a.clientX,this._clientY=a.clientY},stopPanning:function(a){$(document.body).off(".panning"),$(window).off(".panning"),this.$el.removeClass("is-panning"),this.trigger("pan:stop",a)},getPadding:function(){var a=this.options.padding;return _.isFunction(a)&&(a=a.call(this)),joint.util.normalizeSides(a)},getVisibleArea:function(){var a=this.options.paper.matrix(),b={x:this.el.scrollLeft||0,y:this.el.scrollTop||0,width:this.el.clientWidth,height:this.el.clientHeight},c=V.transformRect(b,a.inverse());return c.x-=(this._padding.left||0)/this._sx,c.y-=(this._padding.top||0)/this._sy,g.rect(c)},isElementVisible:function(a,b){this.checkElement(a,"isElementVisible"),b=b||{};var c=b.strict?"containsRect":"intersect";return!!this.getVisibleArea()[c](a.getBBox())},isPointVisible:function(a){return this.getVisibleArea().containsPoint(a)},checkElement:function(a,b){if(!(a&&a instanceof joint.dia.Element))throw new TypeError("ui.PaperScroller."+b+"() accepts instance of joint.dia.Element only")},onRemove:function(){this.stopPanning()}});