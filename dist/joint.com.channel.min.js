/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


if("object"==typeof exports)var WebSocketServer=require("ws").Server,WebSocket=require("ws"),url=require("url");WebSocket=WebSocket||"undefined"!=typeof window&&window.WebSocket,joint.com=joint.com||{},joint.com.Channel=function(a){if(this.options=a,!this.options||!this.options.graph)throw new Error("Channel: missing a graph.");this.options.ttl=this.options.ttl||60,this.options.healthCheckInterval=this.options.healthCheckInterval||36e5,this.options.reconnectInterval=this.options.reconnectInterval||1e4,this.options.serverShouldSendGraph=!!_.isUndefined(this.options.serverShouldSendGraph)||this.options.serverShouldSendGraph,this._isClient=!!this.options.url,this._clients=[],this.messageQueue=[],this.id=this.options.id||(this._isClient?"c_":"s_")+joint.util.uuid(),this.state={},this.state[this.id]=0,this.sites={},this.sites[this.id]={socket:void 0,outgoing:[],ttl:this.options.ttl},this.initialize()},_.extend(joint.com.Channel.prototype,Backbone.Events),joint.com.Channel.prototype.initialize=function(){this.options.graph.on("all",this.onGraphChange.bind(this)),this._isClient?this.connectClient():this.options.port&&(this.server=new WebSocketServer({port:this.options.port}),this.server.on("connection",this.onConnection.bind(this))),this._isClient||(this._healthCheckInterval=setInterval(this.healthCheck.bind(this),this.options.healthCheckInterval))},joint.com.Channel.prototype.connectClient=function(){var a=this.options.url+"/?channelId="+this.id+"&state="+JSON.stringify(this.state)+(this.options.query?"&query="+JSON.stringify(this.options.query):"");this.options.debugLevel>0&&this.log("connectClient",a);var b=new WebSocket(a);b.onopen=this.onConnection.bind(this,b),b.onclose=this.onClose.bind(this,b)},joint.com.Channel.prototype.close=function(){this._reconnectTimeout&&clearTimeout(this._reconnectTimeout),this._healthCheckInterval&&clearInterval(this._healthCheckInterval),this._closed=!0,_.each(this.sites,function(a){a.socket&&a.socket.close()}),this.server&&this.server.close()},joint.com.Channel.prototype.healthCheck=function(){this.options.debugLevel>0&&this.log("healthCheck",_.object(_.keys(this.sites),_.pluck(this.sites,"ttl"))),_.each(this.sites,function(a,b){b!==this.id&&(a.socket&&1===a.socket.readyState?a.ttl=this.options.ttl:a.ttl-=1,a.ttl<=0&&(this.sites=_.omit(this.sites,b),this.state=_.omit(this.state,b)))},this)},joint.com.Channel.prototype.onConnection=function(a){if(this._clients.push(a),this.trigger("open",a),this._isClient)this.sites[this.id].socket=a,a.onmessage=function(b){this.onMessage(a,b.data)}.bind(this);else{var b=url.parse(a.upgradeReq.url,!0),c=b.query.channelId;if(this.sites[c])this.sites[c].socket=a;else if(this.debugLevel>1&&this.log("new_site",c),this.sites[c]={socket:a,outgoing:[],ttl:this.options.ttl},this.state[c]=0,this.options.serverShouldSendGraph){var d={channelId:this.id,state:JSON.parse(JSON.stringify(this.state)),action:"graph",graph:this.options.graph.toJSON()};this.messageQueue.push({type:"op",data:d,source:this.id,target:[c]}),this.send()}a.on("message",this.onMessage.bind(this,a)),a.on("close",this.onClose.bind(this,a))}},joint.com.Channel.prototype.onClose=function(a){var b=this._clients.indexOf(a);b!==-1&&this._clients.splice(b,1),this._isClient&&!this._closed&&(this._reconnectTimeout&&clearTimeout(this._reconnectTimeout),this._reconnectTimeout=setTimeout(this.connectClient.bind(this),this.options.reconnectInterval)),this.trigger("close",a)},joint.com.Channel.prototype.onMessage=function(a,b){this.trigger("message:received",b),this.options.debugLevel>1&&this.log("message",b);try{b=JSON.parse(b)}catch(c){return console.error("Channel: message parsing failed.",c)}if("notification"==b.type)return this.trigger(b.data.event,b.data.data),this.sendNotification(b);var d,e,f=b.data;this._isClient?(d=this.sites[this.id],f=this.receive(d,this.id,f)):(e=this.sites[f.channelId],f=this.receive(e,f.channelId,f),d=this.sites[this.id],f=this.receive(d,this.id,f)),"graph"===f.action?this.state[f.channelId]=f.state[f.channelId]:this.state[f.channelId]=(this.state[f.channelId]||0)+1,this.options.debugLevel>1&&this.log("new state",this.state),this.execute(f),_.each(this.sites,function(a,b){b!==this.id&&b!==f.channelId&&this.receive(a,b,f)},this),this._isClient||(b.op=f,this.messageQueue.push(b),this.broadcast(b)),this.trigger("message:processed",b)},joint.com.Channel.prototype.receive=function(a,b,c){if(!a)return c;this.options.debugLevel>1&&this.log("receive",b,c),this.options.debugLevel>1&&this.log("outgoing",a.outgoing),a.outgoing=_.filter(a.outgoing,function(a){return a.state[a.channelId]>=(c.state[a.channelId]||0)}),this.options.debugLevel>1&&this.log("outgoing.length",a.outgoing.length);for(var d=0;d<a.outgoing.length;d++){var e=a.outgoing[d],f=this.transform(c,e);c=f[0],a.outgoing[d]=f[1]}return c},joint.com.Channel.prototype.transform=function(a,b){return this.options.debugLevel>1&&this.log("transform",a,b),"change:target"===a.action&&"remove"===b.action&&a.cell.target.id===b.cell.id&&(a.cell.target={x:0,y:0}),"change:source"===a.action&&"remove"===b.action&&a.cell.source.id===b.cell.id&&(a.cell.source={x:0,y:0}),[a,b]},joint.com.Channel.prototype.execute=function(a){var b;switch(a.action){case"add":this.options.graph.addCell(a.cell,{remote:!0});break;case"remove":b=this.options.graph.getCell(a.cell.id),b&&b.remove({remote:!0,disconnectLinks:!0});break;case"graph":this.options.graph.fromJSON(a.graph);break;default:var c=a.action.substr("change:".length);b=this.options.graph.getCell(a.cell.id),b&&b.set(c,a.cell[c],{remote:!0})}},joint.com.Channel.prototype.broadcast=function(a){this._isClient?a.target=_.keys(this.sites):a.target=_.keys(_.omit(this.sites,this.id,a.source)),this.send()},joint.com.Channel.prototype.send=function(){if(!this._paused){for(var a=[],b=0;b<this.messageQueue.length;b++){var c=this.messageQueue[b];this.sendMessage(c)&&a.push(b)}a.forEach(_.bind(function(a){this.messageQueue.splice(a,1)},this))}},joint.com.Channel.prototype.sendMessage=function(a){this.debugLevel>1&&this.log("sendMessage",a);var b=[];return a.target.forEach(function(c,d){var e=this.sites[c];return e?void(e.socket&&1===e.socket.readyState&&(this.debugLevel>1&&this.log("sendMessage",c,a),e.socket.send(JSON.stringify(a)),b.push(d))):b.push(d)},this),b.forEach(function(b){a.target.splice(b,1)}),!a.target.length},joint.com.Channel.prototype.log=function(a,b){var c="Channel ["+this.id+"] "+a.toUpperCase()+": ";console.log.apply(console,[c].concat(Array.prototype.slice.call(arguments,1)))},joint.com.Channel.prototype.pause=function(){this._paused=!0},joint.com.Channel.prototype.unpause=function(){this._paused=!1,this.send()},joint.com.Channel.prototype.notify=function(a,b){var c={type:"notification",source:this.id,data:{event:a,data:b}};this.sendNotification(c)},joint.com.Channel.prototype.sendNotification=function(a){this._isClient?a.target=_.keys(this.sites):a.target=_.keys(_.omit(this.sites,this.id,a.source)),this.sendMessage(a)},joint.com.Channel.prototype.onGraphChange=function(a,b,c,d){if(!d||!d.remote){var e="add"===a||"remove"===a||"change:"===a.substr(0,"change:".length);if(e){var f={channelId:this.id,state:JSON.parse(JSON.stringify(this.state)),action:a,cell:b.toJSON()},g={type:"op",data:f,source:this.id};this.options.debugLevel>1&&this.log("generate",g),this.messageQueue.push(g),this.broadcast(g),this.sites[this.id].outgoing.push(f),this.state[this.id]++}}},joint.com.ChannelHub=function(a){if(this.options=a,!this.options.port)throw new Error("ChannelHub: missing a port.");this.initialize()},_.extend(joint.com.ChannelHub.prototype,Backbone.Events),joint.com.ChannelHub.prototype.initialize=function(){this.server=new WebSocketServer({port:this.options.port}),this.server.on("connection",this.onConnection.bind(this))},joint.com.ChannelHub.prototype.onConnection=function(a){var b=url.parse(a.upgradeReq.url,!0),c={query:b.query};if(!this.router)throw new Error("ChannelHub: missing a router.");var d=!1,e=this.router(c,function(b,c){if(b)throw new Error(b);c&&!d&&(c.onConnection(a),d=!0)});e instanceof joint.com.Channel&&(e.onConnection(a),d=!0)},joint.com.ChannelHub.prototype.route=function(a){this.router=a},joint.com.ChannelHub.prototype.close=function(){this.server.close()};