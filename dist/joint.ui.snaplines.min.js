/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Snaplines=joint.mvc.View.extend({options:{paper:void 0,distance:10},className:"snaplines",init:function(){_.bindAll(this,"hide"),this.$horizontal=$("<div>").addClass("snapline horizontal").appendTo(this.el),this.$vertical=$("<div>").addClass("snapline vertical").appendTo(this.el),this.$el.hide().appendTo(this.options.paper.el),this.startListening()},startListening:function(){this.stopListening(),this.listenTo(this.options.paper,"cell:pointerdown",this.captureCursorOffset),this.listenTo(this.options.paper,"cell:pointermove",this.snapWhileMoving),this.listenTo(this.options.paper.model,"batch:stop",this.onBatchStop),$(document).on("mouseup touchend",this.hide),this.filterTypes={},this.filterCells={},this.filterFunction=void 0,_.isArray(this.options.filter)?_.each(this.options.filter,function(a){_.isString(a)?this.filterTypes[a]=!0:this.filterCells[a.id]=!0},this):_.isFunction(this.options.filter)&&(this.filterFunction=this.options.filter)},onBatchStop:function(a){a=a||{},"resize"===a.batchName&&this.snapWhileResizing(a.cell,a)},captureCursorOffset:function(a,b,c,d){if(this.canElementMove(a)){var e=a.model.get("position");this._cursorOffset={x:c-e.x,y:d-e.y}}},snapWhileResizing:function(a,b){if(b.ui&&!b.snapped&&b.direction&&b.trueDirection){var c=this.options.paper.findViewByModel(a);if(c&&c.model.isElement()){var d=a.getBBox(),e=d.bbox(a.get("angle")),f=e.origin(),h=e.corner(),i=g.normalizeAngle(a.get("angle")),j=this.options.distance,k=null,l=null,m={vertical:0,horizontal:0},n=b.direction,o=b.trueDirection,p=b.relativeDirection;if(o.indexOf("right")!==-1?m.vertical=h.x:m.vertical=f.x,o.indexOf("bottom")!==-1?m.horizontal=h.y:m.horizontal=f.y,_.find(this.options.paper.model.getElements(),function(b){if(b.id===a.id||b.isEmbeddedIn(a)||this.filterTypes[b.get("type")]||this.filterCells[b.id]||this.filterFunction&&this.filterFunction(b))return!1;var c=b.getBBox().bbox(b.get("angle")),d=c.origin(),e=c.corner(),f={vertical:[d.x,e.x],horizontal:[d.y,e.y]};return _.each(f,function(a,b){a=_.map(a,function(a){return{position:a,distance:Math.abs(a-m[b])}}),a=_.filter(a,function(a){return a.distance<j}),a=_.sortBy(a,function(a,b){return a.distance>b.distance?1:a.distance===b.distance?0:-1}),f[b]=a}),_.isNull(k)&&f.vertical.length>0&&(k=f.vertical[0].position),_.isNull(l)&&f.horizontal.length>0&&(l=f.horizontal[0].position),_.isNumber(k)&&_.isNumber(l)},this),this.hide(),_.isNumber(k)||_.isNumber(l)){var q=0;_.isNumber(k)&&(q=o.indexOf("right")!==-1?k-e.corner().x:e.origin().x-k);var r=0;_.isNumber(l)&&(r=o.indexOf("bottom")!==-1?l-e.corner().y:e.origin().y-l);var s=0,t=0,u=!(i%90);if(u)90===i||270===i?(s=r,t=q):(s=q,t=r);else{var v;v=i>=0&&i<90?1:i>=90&&i<180?4:i>=180&&i<270?3:2,l&&k&&(r>q?(r=0,l=null):(q=0,k=null));var w=g.toRad(i%90);q&&(s=3===v?q/Math.cos(w):q/Math.sin(w)),r&&(t=3===v?r/Math.cos(w):r/Math.sin(w));var x=1===v||3===v;switch(p){case"top":case"bottom":t=r?r/(x?Math.cos(w):Math.sin(w)):q/(x?Math.sin(w):Math.cos(w));break;case"left":case"right":s=q?q/(x?Math.cos(w):Math.sin(w)):r/(x?Math.sin(w):Math.cos(w))}}switch(p){case"top":case"bottom":s=0;break;case"left":case"right":t=0}var y=this.options.paper.options.gridSize,z=Math.max(d.width+s,y),A=Math.max(d.height+t,y);b.minWidth&&b.minWidth>y&&(z=Math.max(z,b.minWidth)),b.minHeight&&b.minHeight>y&&(A=Math.max(A,b.minHeight)),b.maxWidth&&(z=Math.min(z,b.maxWidth)),b.maxHeight&&(A=Math.min(A,b.maxHeight)),b.preserveAspectRatio&&(s>t?A=z*(d.height/d.width):z=A*(d.width/d.height)),z===d.width&&A===d.height||a.resize(z,A,{snaplines:this.cid,restrictedArea:this.options.paper.getRestrictedArea(c),direction:n,relativeDirection:p,trueDirection:o,snapped:!0});var B=a.getBBox().bbox(i),C=1;k&&Math.abs(B.x-k)>C&&Math.abs(B.width+B.x-k)>C&&(k=null),l&&Math.abs(B.y-l)>C&&Math.abs(B.height+B.y-l)>C&&(l=null),this.show({vertical:k,horizontal:l})}}}},canElementMove:function(a){return a&&a.model.isElement()&&a.can("elementMove")},snapWhileMoving:function(a,b,c,d){if(this.canElementMove(a)){var e=a.model,f=e.get("position"),h=e.get("size"),i=g.rect(_.extend({x:c-this._cursorOffset.x,y:d-this._cursorOffset.y},h)),j=i.center(),k=i.bbox(e.get("angle")),l=k.origin(),m=k.corner(),n=this.options.distance,o=null,p=null,q=0,r=0;if(_.find(this.options.paper.model.getElements(),function(a){if(a===e||a.isEmbeddedIn(e)||this.filterTypes[a.get("type")]||this.filterCells[a.id]||this.filterFunction&&this.filterFunction(a))return!1;var b=a.getBBox().bbox(a.get("angle")),c=b.center(),d=b.origin(),f=b.corner();return _.isNull(o)&&(Math.abs(c.x-j.x)<n?(o=c.x,q=.5):Math.abs(d.x-l.x)<n?o=d.x:Math.abs(d.x-m.x)<n?(o=d.x,q=1):Math.abs(f.x-m.x)<n?(o=f.x,q=1):Math.abs(f.x-l.x)<n&&(o=f.x)),_.isNull(p)&&(Math.abs(c.y-j.y)<n?(p=c.y,r=.5):Math.abs(d.y-l.y)<n?p=d.y:Math.abs(d.y-m.y)<n?(p=d.y,r=1):Math.abs(f.y-m.y)<n?(p=f.y,r=1):Math.abs(f.y-l.y)<n&&(p=f.y)),_.isNumber(o)&&_.isNumber(p)},this),this.hide(),_.isNumber(o)||_.isNumber(p)){_.isNumber(o)&&(k.x=o-q*k.width),_.isNumber(p)&&(k.y=p-r*k.height);var s=k.center(),t=s.x-i.width/2,u=s.y-i.height/2;e.translate(t-f.x,u-f.y,{restrictedArea:this.options.paper.getRestrictedArea(a),snapped:!0}),this.show({vertical:o,horizontal:p})}}},show:function(a){a=a||{};var b=this.options.paper.matrix();a.horizontal?this.$horizontal.css("top",a.horizontal*b.d+b.f).show():this.$horizontal.hide(),a.vertical?this.$vertical.css("left",a.vertical*b.a+b.e).show():this.$vertical.hide(),this.$el.show()},hide:function(){this.$el.hide()},onRemove:function(){$(document).off("mouseup",this.hide)}});