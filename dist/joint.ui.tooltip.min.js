/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Tooltip=joint.mvc.View.extend({className:"tooltip",options:{left:void 0,right:void 0,top:void 0,bottom:void 0,position:void 0,positionSelector:void 0,direction:"auto",minResizedWidth:100,padding:0,rootTarget:null,target:null,trigger:"hover",viewport:{selector:null,padding:0},dataAttributePrefix:"tooltip",template:'<div class="tooltip-arrow"/><div class="tooltip-arrow-mask"/><div class="tooltip-content"/>'},init:function(){this.eventNamespace=("."+this.className+this.cid).replace(/ /g,"_"),this.settings={};var a=this.options.trigger.split(" ");_.bindAll(this,"render","hide","show","toggle","isVisible","position"),this.options.rootTarget?(this.$rootTarget=$(this.options.rootTarget),_.each(a,function(a){switch(a){case"click":this.$rootTarget.on("click"+this.eventNamespace,this.options.target,this.toggle);break;case"hover":this.$rootTarget.on("mouseover"+this.eventNamespace,this.options.target,this.render);break;case"focus":this.$rootTarget.on("focusin"+this.eventNamespace,this.options.target,this.render)}},this)):(this.$target=$(this.options.target),_.each(a,function(a){switch(a){case"click":this.$target.on("click"+this.eventNamespace,this.toggle);break;case"hover":this.$target.on("mouseover"+this.eventNamespace,this.render);break;case"focus":this.$target.on("focusin"+this.eventNamespace,this.render)}},this)),this.$el.append(this.options.template)},onRemove:function(){this.options.rootTarget?this.$rootTarget.off(this.eventNamespace):this.$target.off(this.eventNamespace)},hide:function(){var a=this.settings;a&&(this.unbindHideActions(a.currentTarget),this.$el.removeClass(a.className),this.$el.remove())},show:function(a){this.render(a||{target:this.options.target})},toggle:function(a){this.isVisible()?this.hide():this.show(a)},isVisible:function(){return document.body.contains(this.el)},render:function(a){var b=_.isUndefined(a.x)||_.isUndefined(a.y)?null:a,c=$(a.target).closest(this.options.target)[0],d=this.settings=this.getTooltipSettings(c);d.currentTarget=c,this.bindHideActions(c);var e;e=b?{x:b.x,y:b.y,width:1,height:1}:joint.util.getElementBBox(c),this.$(".tooltip-content").html(d.content),this.$el.hide(),this.$el.removeClass("left right top bottom"),this.$el.addClass(d.className),$(document.body).append(this.$el);var f=this.$("img");f.length?f.on("load",_.bind(function(){this.position(e),this.$el.addClass("rendered")},this)):(this.position(e),this.$el.addClass("rendered"))},getTooltipSettings:function(a){var b=this.loadDefinitionFromElementData(a);return this.evaluateOptions(a,b)},unbindHideActions:function(a){var b=this.eventNamespace+".remove";$(a).off(b),clearInterval(this.interval)},bindHideOnRemoveTarget:function(a){clearInterval(this.interval),this.interval=setInterval(_.bind(function(){$.contains(document,a)||(clearInterval(this.interval),this.hide())},this),500)},bindHideActions:function(a){var b=this.settings,c=$(a),d=this.eventNamespace+".remove";this.bindHideOnRemoveTarget(a),_.each(this.options.trigger.split(" "),function(a){var e={hover:["mouseout","mousedown"],focus:["focusout"]},f=e[a]||[];b.hideTrigger&&(f=b.hideTrigger.split(" ")||[]),_.each(f,function(a){c.on(a+d,this.hide)},this)},this)},evaluateOptions:function(a,b){b=b||{};var c=_.extend({},b,this.options);return _.each(c,function(d,e){var f=_.isFunction(d)?d(a):d;c[e]=_.isUndefined(f)||_.isNull(f)?b[e]:f}),this.normalizePosition(c),c},loadDefinitionFromElementData:function(a){if(!a)return{};var b=function(a){return"left"===a||"bottom"===a||"top"===a||"right"===a},c=this.getAllAttrs(a,"data-"+this.options.dataAttributePrefix),d={};return _.each(c,function(a,c){""===c&&(c="content"),b(c)||(d[c]=a)}),d},getAllAttrs:function(a,b){var c=b||"",d=a.attributes,e={};return _.each(d,function(a){if(_.startsWith(a.name,c)){var b=_.camelCase(a.name.slice(c.length));e[b]=a.value}}),e},normalizePosition:function(a){var b=a.left||a.right||a.top||a.bottom;!a.position&&b&&(a.left&&(a.position="left"),a.right&&(a.position="right"),a.top&&(a.position="top"),a.bottom&&(a.position="bottom")),!a.positionSelector&&b&&(a.positionSelector=b)},position:function(a){var b=this.settings;this.$el.show(),this.$el.css("width","auto");var c=this.getViewportViewBBox(),d=this.getTooltipBBox(a,c),e={};"left"===b.position||"right"===b.position?e.top=a.y+a.height/2-d.y:"top"===b.position||"bottom"===b.position?e.left=a.x+a.width/2-d.x:e.top=a.y+a.height/2-d.y,this.$el.css({left:d.x,top:d.y,width:d.width||"auto"});var f=this.$(".tooltip-arrow, .tooltip-arrow-mask");f.removeAttr("style"),f.css(e),b.direction&&"off"!==b.direction&&this.$el.addClass("auto"===b.direction?b.position||"left":b.direction)},getViewportViewBBox:function(){var a=this.settings,b=a.viewport.selector?$(a.currentTarget).closest(a.viewport.selector):"html",c=joint.util.getElementBBox(b),d=$(window);a.viewport.selector||(c.width=d.width()+d.scrollLeft(),c.height=d.height()+d.scrollTop());var e=a.viewport.padding||0;return c.x+=e,c.y+=e,c.width-=2*e,c.height-=2*e,c},getPosition:function(a,b,c,d){var e=this.settings,f=e.position||"left",g=e.padding,h=Math.min(e.minResizedWidth,c.width+g),i={left:function(f){var i={x:a.x+a.width+g,y:b.y+b.height/2-c.height/2};if(f){var j=d.x+d.width-i.x;if(j>h&&j<c.width+g&&(i.width=j),j<h)return e.position="right",this.right(!1)}return i},right:function(f){var i={x:a.x-c.width-g,y:b.y+b.height/2-c.height/2};if(f){var j=a.x-g-d.x;if(j>h&&j<c.width+g&&(i.width=j,i.x=d.x),j<h)return e.position="left",this.left(!1)}return i},top:function(f){var h={x:b.x+b.width/2-c.width/2,y:a.y+a.height+g};if(f){var i=d.y+d.height-(a.y+a.height+g);if(i<c.height)return e.position="bottom",this.bottom(!1)}return h},bottom:function(f){var h={x:b.x+b.width/2-c.width/2,y:a.y-c.height-g};if(f){var i=a.y-g-d.y;if(i<c.height)return e.position="top",this.top(!1)}return h}};return i[f](h>0)},getTooltipBBox:function(a,b){var c,d,e=this.measureTooltipElement();c=$(this.settings.positionSelector),d=c[0]?joint.util.getElementBBox(c[0]):a;var f=this.getPosition(d,a,e,b);f.y<b.y?f.y=b.y:f.y+e.height>b.y+b.height&&(f.y=b.y+b.height-e.height);var g=f.width||e.width;return f.x<b.x?f.x=b.x:f.x+g>b.x+b.width&&(f.x=b.x+b.width-g),f},measureTooltipElement:function(){var a=this.$el.clone().appendTo($("body")).css({left:-1e3,top:-500}),b={width:a.outerWidth(),height:a.outerHeight()};return a.remove(),b}});