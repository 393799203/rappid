/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.layout.ForceDirected=Backbone.Model.extend({defaults:{linkDistance:10,linkStrength:1,charge:10},initialize:function(a){this.elements=this.get("graph").getElements(),this.links=this.get("graph").getLinks(),this.cells=this.get("graph").get("cells"),this.width=this.get("width"),this.height=this.get("height"),this.gravityCenter=this.get("gravityCenter"),this.t=1,this.energy=1/0,this.progress=0},start:function(){var a=this.get("width"),b=this.get("height");_.each(this.elements,function(c){c.set("position",{x:Math.random()*a,y:Math.random()*b}),c.charge=c.get("charge")||this.get("charge"),c.weight=c.get("weight")||1;var d=c.get("position");c.x=d.x,c.y=d.y,c.px=c.x,c.py=c.y,c.fx=0,c.fy=0},this),_.each(this.links,function(a){a.strength=a.get("strength")||this.get("linkStrength"),a.distance=a.get("distance")||this.get("linkDistance"),a.source=this.cells.get(a.get("source").id),a.target=this.cells.get(a.get("target").id)},this)},step:function(){if(.99*this.t<.005)return this.notifyEnd();var a=this.width,b=this.height,c=.1,d=this.gravityCenter,e=this.energy;this.energy=0;var f,g,h,i,j,k,l,m,n,o,p,q=0,r=0,s=0,t=0,u=this.elements.length,v=this.links.length;for(f=0;f<u-1;f++)for(h=this.elements[f],q+=h.x,r+=h.y,g=f+1;g<u;g++)i=this.elements[g],j=i.x-h.x,k=i.y-h.y,l=j*j+k*k,m=Math.sqrt(l),n=this.t*h.charge/l,o=n*j,p=n*k,h.fx-=o,h.fy-=p,i.fx+=o,i.fy+=p,this.energy+=o*o+p*p;q+=this.elements[u-1].x,r+=this.elements[u-1].y;var w,x,y;for(f=0;f<v;f++)w=this.links[f],h=w.source,i=w.target,j=i.x-h.x,k=i.y-h.y,l=j*j+k*k,m=Math.sqrt(l),x=this.t*w.strength*(m-w.distance)/m,o=x*j,p=x*k,y=h.weight/(h.weight+i.weight),h.x+=o*(1-y),h.y+=p*(1-y),i.x-=o*y,i.y-=p*y,this.energy+=o*o+p*p;var z,A;for(f=0;f<u;f++){z=this.elements[f],A={x:z.x,y:z.y},d&&(A.x+=(d.x-A.x)*this.t*c,A.y+=(d.y-A.y)*this.t*c),A.x+=z.fx,A.y+=z.fy,A.x=Math.max(0,Math.min(a,A.x)),A.y=Math.max(0,Math.min(b,A.y));var B=.9;A.x+=(z.px-A.x)*B,A.y+=(z.py-A.y)*B,z.px=A.x,z.py=A.y,z.fx=z.fy=0,z.x=A.x,z.y=A.y,s+=z.x,t+=z.y,this.notify(z,f,A)}this.t=this.cool(this.t,this.energy,e);var C=q-s,D=r-t,E=Math.sqrt(C*C+D*D);E<1&&this.notifyEnd()},cool:function(a,b,c){return b<c?(this.progress+=1,this.progress>=5?(this.progress=0,a/.99):a):(this.progress=0,.99*a)},notify:function(a,b,c){a.set("position",c)},notifyEnd:function(){this.trigger("end")}});