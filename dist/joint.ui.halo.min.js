/*! Rappid v2.1.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2017-09-21 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


!function(a,b){"use strict";var c=function(){this.options={handles:[{name:"remove",position:"nw",events:{pointerdown:"removeElement"},icon:null},{name:"direction",position:"se",events:{pointerdown:"directionSwap"},icon:null}],bbox:function(a){var b=.5*a.getConnectionLength();return a.getPointAtLength(b)},typeCssName:"type-link",tinyThreshold:-1,smallThreshold:-1,boxContent:!1}};c.prototype.directionSwap=function(){var a=this.options.cellView.model;a.set({source:a.get("target"),target:a.get("source")},{halo:this.cid})};var d=function(){this.options={handles:[{name:"remove",position:"nw",events:{pointerdown:"removeElement"},icon:null},{name:"resize",position:"se",events:{pointerdown:"startResizing",pointermove:"doResize",pointerup:"stopBatch"},icon:null},{name:"clone",position:"n",events:{pointerdown:"startCloning",pointermove:"doClone",pointerup:"stopCloning"},icon:null},{name:"link",position:"e",events:{pointerdown:"startLinking",pointermove:"doLink",pointerup:"stopLinking"},icon:null},{name:"fork",position:"ne",events:{pointerdown:"startForking",pointermove:"doFork",pointerup:"stopForking"},icon:null},{name:"unlink",position:"w",events:{pointerdown:"unlinkElement"},icon:null},{name:"rotate",position:"sw",events:{pointerdown:"startRotating",pointermove:"doRotate",pointerup:"stopBatch"},icon:null}],bbox:function(a,b){return a.getBBox({useModelGeometry:b.options.useModelGeometry})},typeCssName:"type-element",tinyThreshold:40,smallThreshold:80,boxContent:function(b,c){var d=a.util.template("x: <%= x %>, y: <%= y %>, width: <%= width %>, height: <%= height %>, angle: <%= angle %>"),e=this.getBBox();return d({x:Math.floor(e.x),y:Math.floor(e.y),width:Math.floor(e.width),height:Math.floor(e.height),angle:Math.floor(b.model.get("angle")||0)})},loopLinkPreferredSide:"top",loopLinkWidth:40,rotateAngleGrid:15,linkAttributes:{},smoothLinks:void 0}};d.prototype.startLinking=function(a,c,d){this.startBatch();var e=this.options.cellView,f=$.data(a.target,"selector"),g=this.options.paper.getDefaultLink(e,f&&e.el.querySelector(f));g.set("source",{id:e.model.id,selector:f}),g.set("target",{x:c,y:d}),g.attr(this.options.linkAttributes),b.isBoolean(this.options.smoothLinks)&&g.set("smooth",this.options.smoothLinks),this.options.graph.addCell(g,{validation:!1,halo:this.cid,async:!1}),this._linkView=this.options.paper.findViewByModel(g),this._linkView.startArrowheadMove("target",{whenNotAllowed:"remove"})},d.prototype.startForking=function(c,d,e){var f=this.options;this.startBatch();var g=f.clone(f.cellView.model,{fork:!0});if(!(g instanceof a.dia.Cell))throw new Error('ui.Halo: option "clone" has to return a cell.');var h=f.paper.getDefaultLink(f.cellView).set({source:{id:f.cellView.model.id},target:{id:g.id}});h.attr(f.linkAttributes),b.isBoolean(f.smoothLinks)&&h.set("smooth",f.smoothLinks),this.centerElementAtCursor(g,d,e),f.graph.addCells([g,h],{halo:this.cid,async:!1}),this._cloneView=g.findView(f.paper),this._cloneView.pointerdown(c,d,e)},d.prototype.startResizing=function(a){this.startBatch(),this._flip=[1,0,0,1,1,0,0,1][Math.floor(g.normalizeAngle(this.options.cellView.model.get("angle"))/45)]},d.prototype.startRotating=function(a,b,c){this.startBatch();var d=this.options.cellView.model.getBBox().center(),e=g.normalizeAngle(this.options.cellView.model.get("angle"));this._center=d,this._rotationStartAngle=e||0,this._clientStartAngle=g.point(b,c).theta(d)},d.prototype.doResize=function(a,b,c,d,e){var f=this.options.cellView.model.get("size"),g=Math.max(f.width+(this._flip?d:e),1),h=Math.max(f.height+(this._flip?e:d),1);this.options.cellView.model.resize(g,h,{absolute:!0})},d.prototype.doRotate=function(a,b,c){var d=this._clientStartAngle-g.point(b,c).theta(this._center),e=g.snapToGrid(this._rotationStartAngle+d,this.options.rotateAngleGrid);this.options.cellView.model.rotate(e,!0)},d.prototype.doClone=function(a,b,c){this._cloneView.pointermove(a,b,c)},d.prototype.startCloning=function(b,c,d){var e=this.options;this.startBatch();var f=e.clone(e.cellView.model,{clone:!0});if(!(f instanceof a.dia.Cell))throw new Error('ui.Halo: option "clone" has to return a cell.');this.centerElementAtCursor(f,c,d),f.addTo(e.graph,{halo:this.cid,async:!1}),this._cloneView=f.findView(e.paper),this._cloneView.pointerdown(b,c,d)},d.prototype.centerElementAtCursor=function(a,b,c){var d=a.getBBox().center(),e=b-d.x,f=c-d.y;a.translate(e,f)},d.prototype.doFork=function(a,b,c){this._cloneView.pointermove(a,b,c)},d.prototype.doLink=function(a,b,c){this._linkView&&this._linkView.pointermove(a,b,c)},d.prototype.stopLinking=function(a){this._linkView&&(this._linkView.pointerup(a),this._linkView.model.hasLoop()&&this.makeLoopLink(this._linkView.model),this.stopBatch(),this.triggerAction("link","add",this._linkView.model),this._linkView=null)},d.prototype.stopForking=function(a,b,c){this._cloneView.pointerup(a,b,c),this.stopBatch()},d.prototype.stopCloning=function(a,b,c){this._cloneView.pointerup(a,b,c),this.stopBatch()},d.prototype.unlinkElement=function(a){this.startBatch(),this.options.graph.removeLinks(this.options.cellView.model),this.stopBatch()},d.prototype.makeLoopLink=function(a){var c,d,e=this.options.loopLinkWidth,f=this.options.paper.options,h=g.rect({x:0,y:0,width:f.width,height:f.height}),i=V(this.options.cellView.el).bbox(!1,this.options.paper.viewport),j=b.uniq([this.options.loopLinkPreferredSide,"top","bottom","left","right"]),k=b.find(j,function(a){var b,f=0,j=0;switch(a){case"top":b=g.point(i.x+i.width/2,i.y-e),f=e/2;break;case"bottom":b=g.point(i.x+i.width/2,i.y+i.height+e),f=e/2;break;case"left":b=g.point(i.x-e,i.y+i.height/2),j=e/2;break;case"right":b=g.point(i.x+i.width+e,i.y+i.height/2),j=e/2}return c=g.point(b).offset(-f,-j),d=g.point(b).offset(f,j),h.containsPoint(c)&&h.containsPoint(d)},this);k&&a.set("vertices",[c,d])},a.ui.Halo=a.mvc.View.extend({PIE_INNER_RADIUS:20,PIE_OUTER_RADIUS:50,className:"halo",events:{"mousedown .handle":"onHandlePointerDown","touchstart .handle":"onHandlePointerDown","mousedown .pie-toggle":"onPieTogglePointerDown","touchstart .pie-toggle":"onPieTogglePointerDown"},options:{clearAll:!0,clearOnBlankPointerdown:!0,useModelGeometry:!1,clone:function(a,b){return a.clone().unset("z")},type:"surrounding",pieSliceAngle:45,pieStartAngleOffset:0,pieIconSize:14,pieToggles:[{name:"default",position:"e"}]},init:function(){var a=this.options,e=a.cellView,f=e.model,g=f.isLink()?new c:new d;b.assign(this,b.omit(g,"options"));var h=e.paper,i=h.model;b.defaults(a,g.options,{paper:h,graph:i}),b.bindAll(this,"pointermove","pointerup","render","update"),a.clearAll&&this.constructor.clear(h),this.listenTo(i,"reset",this.remove),this.listenTo(f,"remove",this.remove),this.listenTo(h,"halo:create",this.remove),a.clearOnBlankPointerdown&&this.listenTo(h,"blank:pointerdown",this.remove),this.listenTo(i,"all",this.update),this.listenTo(h,"scale translate",this.update),$(document.body).on("mousemove touchmove",this.pointermove),$(document).on("mouseup touchend",this.pointerup),this.handles=[],b.each(a.handles,this.addHandle,this)},render:function(){var c=this.options;switch(this.$el.empty(),this.$handles=$("<div/>").addClass("handles").appendTo(this.el),this.$box=$("<label/>").addClass("box").appendTo(this.el),this.$pieToggles={},this.$el.addClass(c.type),this.$el.addClass(this.cellTypeCssClass()),this.$el.attr("data-type",c.cellView.model.get("type")),this.$handles.append(b.map(this.handles,this.renderHandle,this)),c.type){case"toolbar":case"surrounding":this.hasHandle("fork")&&this.toggleFork();break;case"pie":b.each(this.options.pieToggles,function(b){var c=$("<div/>");c.addClass("pie-toggle "+(b.position||"e")),c.attr("data-name",b.name),a.util.setAttributesBySelector(c,b.attrs),c.appendTo(this.el),this.$pieToggles[b.name]=c},this);break;default:throw new Error("ui.Halo: unknown type")}return this.update(),this.$el.addClass("animate").appendTo(c.paper.el),this.setPieIcons(),this},setPieIcons:function(){"pie"===this.options.type&&this.$el.find(".handle").each(b.bind(function(a,b){var c,d=$(b),e=d.attr("data-action"),f=this.getHandle(e);if(!f||!f.icon){var g=window.getComputedStyle(b,":before").getPropertyValue("content");g&&"none"!==g&&(c=d.find(".slice-text-icon"),c.length>0&&V(c[0]).text(g.replace(/['"]/g,"")));var h=d.css("background-image");if(h){var i=h.match(/url\(['"]?([^'"]+)['"]?\)/);if(i){var j=i[1];c=d.find(".slice-img-icon"),c.length>0&&V(c[0]).attr("xlink:href",j)}}}},this))},update:function(){if(this.isRendered()){this.updateBoxContent();var a=this.getBBox();this.$el.toggleClass("tiny",a.width<this.options.tinyThreshold&&a.height<this.options.tinyThreshold),this.$el.toggleClass("small",!this.$el.hasClass("tiny")&&a.width<this.options.smallThreshold&&a.height<this.options.smallThreshold),this.$el.css({width:a.width,height:a.height,left:a.x,top:a.y}),this.hasHandle("unlink")&&this.toggleUnlink()}},getBBox:function(){var a=this.options.cellView,c=this.options.bbox,d=b.isFunction(c)?c(a,this):c;return d=b.defaults({},d,{x:0,y:0,width:1,height:1}),g.rect(d)},cellTypeCssClass:function(){return this.options.typeCssName},updateBoxContent:function(){var a=this.options.boxContent,c=this.options.cellView;if(b.isFunction(a)){var d=a.call(this,c,this.$box[0]);d&&this.$box.html(d)}else a?this.$box.html(a):this.$box.remove()},extendHandles:function(a){b.each(a,function(a){var c=this.getHandle(a.name);c&&b.extend(c,a)},this)},addHandles:function(a){return b.each(a,this.addHandle,this),this},addHandle:function(a){var c=this.getHandle(a.name);return c||(this.handles.push(a),b.each(a.events,function(c,d){b.isString(c)?this.on("action:"+a.name+":"+d,this[c],this):this.on("action:"+a.name+":"+d,c)},this),this.$handles&&this.renderHandle(a).appendTo(this.$handles)),this},renderHandle:function(b){var c=this.getHandleIdx(b.name),d=$("<div/>").addClass("handle").addClass(b.name).attr("data-action",b.name).prop("draggable",!1);switch(this.options.type){case"toolbar":case"surrounding":d.addClass(b.position),b.content&&d.html(b.content);break;case"pie":var e=this.PIE_OUTER_RADIUS,f=this.PIE_INNER_RADIUS,h=(e+f)/2,i=g.point(e,e),j=g.toRad(this.options.pieSliceAngle),k=c*j+g.toRad(this.options.pieStartAngleOffset),l=k+j,m=V.createSlicePathData(f,e,k,l),n=V("svg").addClass("slice-svg"),o=V("path").attr("d",m).translate(e,e).addClass("slice"),p=g.point.fromPolar(h,-k-j/2,i),q=this.options.pieIconSize,r=V("image").attr(p).addClass("slice-img-icon");p.y=p.y+q-2;var s=V("text",{"font-size":q}).attr(p).addClass("slice-text-icon");r.attr({width:q,height:q}),r.translate(-q/2,-q/2),s.translate(-q/2,-q/2),n.append([o,r,s]),d.append(n.node)}return b.icon&&this.setHandleIcon(d,b.icon),a.util.setAttributesBySelector(d,b.attrs),d},setHandleIcon:function(a,b){switch(this.options.type){case"pie":var c=a.find(".slice-img-icon");V(c[0]).attr("xlink:href",b);break;case"toolbar":case"surrounding":a.css("background-image","url("+b+")")}},removeHandles:function(){for(;this.handles.length;)this.removeHandle(this.handles[0].name);return this},removeHandle:function(a){var c=this.getHandleIdx(a),d=this.handles[c];return d&&(b.each(d.events,function(b,c){this.off("action:"+a+":"+c)},this),this.$(".handle."+a).remove(),this.handles.splice(c,1)),this},changeHandle:function(a,c){var d=this.getHandle(a);return d&&(this.removeHandle(a),this.addHandle(b.merge({name:a},d,c))),this},hasHandle:function(a){return this.getHandleIdx(a)!==-1},getHandleIdx:function(a){return b.findIndex(this.handles,{name:a})},getHandle:function(a){return b.findWhere(this.handles,{name:a})},toggleHandle:function(a,c){var d=this.getHandle(a);if(d){var e=this.$(".handle."+a);b.isUndefined(c)&&(c=!e.hasClass("selected")),e.toggleClass("selected",c);var f=c?d.iconSelected:d.icon;f&&this.setHandleIcon(e,f)}return this},selectHandle:function(a){return this.toggleHandle(a,!0)},deselectHandle:function(a){return this.toggleHandle(a,!1)},deselectAllHandles:function(){return b.chain(this.handles).pluck("name").each(this.deselectHandle,this).value(),this},onHandlePointerDown:function(b){if(this._action=$(b.target).closest(".handle").attr("data-action"),this._action){b.preventDefault(),b.stopPropagation(),b=a.util.normalizeEvent(b);var c=this.options.paper.snapToGrid({x:b.clientX,y:b.clientY});this._localX=c.x,this._localY=c.y,this._evt=b,this.triggerAction(this._action,"pointerdown",b,c.x,c.y)}},onPieTogglePointerDown:function(a){a.stopPropagation();var b=$(a.target).closest(".pie-toggle"),c=b.attr("data-name");this.isOpen(c)?this.toggleState(c):this.isOpen()?(this.toggleState(),this.toggleState(c)):this.toggleState(c)},triggerAction:function(a,b,c){var d=Array.prototype.slice.call(arguments,2);d.unshift("action:"+a+":"+b),this.trigger.apply(this,d)},stopBatch:function(){this.options.graph.stopBatch("halo",{halo:this.cid})},startBatch:function(){this.options.graph.startBatch("halo",{halo:this.cid})},pointermove:function(b){if(this._action){b.preventDefault(),b.stopPropagation(),b=a.util.normalizeEvent(b);var c=this.options.paper.snapToGrid({x:b.clientX,y:b.clientY}),d=c.x-this._localX,e=c.y-this._localY;this._localX=c.x,this._localY=c.y,this._evt=b,this.triggerAction(this._action,"pointermove",b,c.x,c.y,d,e)}},pointerup:function(a){var b=this._action;if(b){this._action=null,this._evt=null;var c=this.options.paper.snapToGrid({x:a.clientX,y:a.clientY});this.triggerAction(b,"pointerup",a,c.x,c.y)}},onRemove:function(){$(document.body).off("mousemove touchmove",this.pointermove),$(document).off("mouseup touchend",this.pointerup),this._action&&this._evt&&this.pointerup(this._evt),this.options.graph.hasActiveBatch("halo")&&this.stopBatch()},onSetTheme:function(){this.setPieIcons()},removeElement:function(){this.options.cellView.model.remove()},toggleUnlink:function(){var a=this.options.graph.getConnectedLinks(this.options.cellView.model).length>0;this.$handles.children(".unlink").toggleClass("hidden",!a)},toggleFork:function(){var a=this.options.cellView.model.clone(),b=this.options.paper.createViewForModel(a),c=this.options.paper.options.validateConnection(this.options.cellView,null,b,null,"target");this.$handles.children(".fork").toggleClass("hidden",!c),b.remove(),a=null},toggleState:function(a){if(this.isRendered()){var c=this.$el;if(b.each(this.$pieToggles,function(a){a.removeClass("open")}),this.isOpen())this.trigger("state:close",a),c.removeClass("open");else{if(this.trigger("state:open",a),a){var d=b.findWhere(this.options.pieToggles,{name:a});d&&c.attr({"data-pie-toggle-position":d.position,"data-pie-toggle-name":d.name}),this.$pieToggles[a].addClass("open")}c.addClass("open")}}},isOpen:function(a){return!!this.isRendered()&&(a?this.$pieToggles[a].hasClass("open"):this.$el.hasClass("open"))},isRendered:function(){return!b.isUndefined(this.$box)}},{clear:function(a){a.trigger("halo:create")}})}(joint,_);